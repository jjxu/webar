<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>WebAR</title>
	<script type="text/javascript" src="./js-aruco/cv.js"></script>
	<script type="text/javascript" src="./js-aruco/aruco.js"></script>
	<script type="text/javascript" src="./three/three.min.js"></script>
	<script type="text/javascript" src="./three/STLLoader.js"></script>
    <script type="text/javascript" src="./libs/stats.js"></script>
    <script type="text/javascript" src="./libs/dat.gui.js"></script>
	<script type="text/javascript" src="./jsfeat/jsfeat-min.js"></script>
<!--    <script type="text/javascript" src="./libs/jquery-1.11.2.min.js"></script> -->
<style>
	.div-relative{position:relative; color:#000; border:1px solid #000; width:100%; height:100%}    
	.div-screen{ position:absolute; left:0px; top:0px; background-color:transparent; width:100%; height:100%}    
	.div-b{ position:absolute; left:0px; top:0px; background-color:transparent; width:100%; height:80%} 
	body{margin: 0; overflow: hidden;}
</style>
</head>
<body>
	<div class="div-screen">
		<video id="webcam" autoplay style="width:100%; height: 100%; object-fit: fill">您的浏览器不支持video标签。 </video>
	</div>
<!--	<div class="div-screen">
		<canvas id="bufcan" style="display:none"></canvas>
	</div> -->
	<div class="div-screen">
		<canvas id="canvas" style="display:block"></canvas>
	</div>

	<script type="text/javascript">
		var width = window.innerWidth;
		var height = window.innerHeight;
		var size = width * height;
		console.log("size:" + width + "*" + height);
		var webcam = document.getElementById('webcam');
	//	var bufcan = document.getElementById('bufcan');
	//	var bufctx = bufcan.getContext('2d');
	//	bufcan.width = width;
	//	bufcan.height = height;
		//bufcan.style.width = winW + 'px';
		//bufcan.style.height = winH + 'px';
		
		var canvas = document.getElementById('canvas');
		var context = canvas.getContext('2d');
		canvas.width = width;
		canvas.height = height;
		
		//alert(width + ":" + height);
		
		function hasGetUserMedia() {
			return  !!(navigator.getUserMedia
				|| navigator.webkitGetUserMedia || navigator.mozGetUserMedia
				|| navigator.msGetUserMedia);
		}
		
		window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL;
		var exArray = []; //存储设备源ID
		//MediaStreamTrack.getSources(function(sourceInfos) {
		navigator.mediaDevices.enumerateDevices().then(function(sourceInfos) {
			for (var i = 0; i != sourceInfos.length; i++) {
				var sourceInfo = sourceInfos[i];
				//这里会遍历audio,video，所以要加以区分  
				/*
				if(sourceInfo.kind == "video" && sourceInfo.facing == "environment") {
					constraints.video = {
						optional: [{sourceId: sourceInfo.id}]
					}
				}*/
				if (sourceInfo.kind === 'video') {
					exArray.push(sourceInfo.id);
				}
			}
		});

		function openWebCam() {
			if (navigator.getUserMedia) { // 标准的API
				navigator.getUserMedia({
					video : {
						//width: 300, height: 150,
						'optional' : [ {
							'sourceId' : exArray[0] //0为前置摄像头，1为后置  
						} ]
					},
					audio : false
				}, successFunc, errorFunc);
			} else if (navigator.webkitGetUserMedia) { // WebKit 核心的API
				navigator.webkitGetUserMedia({
					video : {
						'optional' : [ {
							'sourceId' : exArray[0] //0为前置摄像头，1为后置  
						} ]
					},
					audio : false
				}, successFunc, errorFunc);
			} else {
				alert('Native device media streaming (getUserMedia) not supported in your browser.');
			}
		}

		var localStream, grayImg, blurImg;
		var corners = [];
		function successFunc(stream) {
			webcam.src = window.URL && window.URL.createObjectURL(stream) || stream;
			//video.src = URL.createObjectURL(stream);
			//video.src = stream;
			webcam.play();
			localStream = stream;

			grayImg = new jsfeat.matrix_t(width, height, jsfeat.U8_t | jsfeat.C1_t);
			blurImg = new jsfeat.matrix_t(width, height, jsfeat.U8_t | jsfeat.C1_t);
			// you should use preallocated keypoint_t array
			for (var i = 0; i < size; i++) {
			    corners[i] = new jsfeat.keypoint_t(0, 0, 0, 0);
			}
		//	context.fillStyle = "green";
		//	context.fillRect(0, 0, 150, 150);
			requestAnimationFrame(imageProcessing);
		}

		function errorFunc(error) {
			console.log("Error:" + error.name);
		}

		function closeWebCam() {
			if (webcam) {
				webcam.pause();
				webcam.src = '';
			//	webcam.load();
			}

			if (localStream && localStream.stop) {
				localStream.stop();
			}
			stream = null;
		}
		
		var imageData;
		function imageProcessing() {
			var last = new Date();
			requestAnimationFrame(imageProcessing);
			if (webcam.readyState === webcam.HAVE_ENOUGH_DATA){
				context.drawImage(webcam, 0, 0, width, height);
				imageData = context.getImageData(0, 0, width, height);
				context.clearRect(0, 0, width, height);

				jsfeat.imgproc.grayscale(imageData.data, width, height, grayImg);
				//jsfeat.imgproc.gaussian_blur(grayImg, blurImg, 5);
				//drawGrayImage(imageData, grayImg);
				
				
				var count = detectKeypoints(grayImg, corners, 100);
				//console.log("keypoint size:" + count);
				drawKeypoints(corners, count);

			//	var cols = 32; // 32 Bytes / 256 BIT descriptor
			//	var rows = count; // descriptors stored per row
				var descriptors = new jsfeat.matrix_t(32, count, jsfeat.U8_t | jsfeat.C1_t);
				jsfeat.orb.describe(grayImg, corners, count, descriptors);
			}
			var now = new Date();
			var fps = 1000.0 / (now.getTime() - last.getTime());
			var tmp = "FPS:" + fps;
			//console.log("FPS:" + fps);
			context.fillText(tmp.substr(0, tmp.indexOf(".") + 2), 20, 20);
		//	snapshot();
		}

		function drawGrayImage(imageData, grayImg) {
			var data_u32 = new Uint32Array(imageData.data.buffer);
            var i = size; //grayImg.cols * grayImg.rows;
            var pix = 0;
            var alpha = (0xff << 24);
            while(--i >= 0) {
            	pix = grayImg.data[i];
            	data_u32[i] = alpha | (pix << 16) | (pix << 8) | pix;
            }
            context.putImageData(imageData, 0, 0);
		}

		function detectKeypoints(image, corners, maxAllowed) {
			//detect features

			//var threshold = 10;
			//var border = 3;
			jsfeat.fast_corners.set_threshold(10);
			var count = jsfeat.fast_corners.detect(image, corners, 3);
			//var count = jsfeat.yape06.detect(image, corners, 17);

            // sort by score and reduce the count if needed
            if(count > maxAllowed) {
            	jsfeat.math.qsort(corners, 0, count - 1, function(a, b){return (b.score < a.score);});
            	count = maxAllowed;
            }
            /*
            // calculate dominant orientation for each keypoint
           	for(var i = 0; i < count; ++i) {
                corners[i].angle = ic_angle(img, corners[i].x, corners[i].y);
            }
			*/
            return count;
        }

        function drawKeypoints(corners, count) {
        	context.fillStyle = "green";
        	for (var i = 0; i < count; i++) {
			    context.fillRect(corners[i].x, corners[i].y, 4, 4);
			}
        }

	//	$(function() { 
	//		alert("xxx");
	//	});
		window.onload = openWebCam();
		window.unload = closeWebCam();
	</script>
</body>
</html>